#!/usr/bin/env bash
# Configure HAProxy for round-robin load balancing between 414383-web-01 and 414383-web-02

set -e  # Exit immediately if a command exits with a non-zero status

# Update the system and install HAProxy
echo "Updating system and installing HAProxy..."
sudo apt-get update -y
sudo apt-get install -y haproxy

# Ensure the hostnames are properly set
echo "Configuring hostnames..."
sudo hostnamectl set-hostname "414383-web-$(hostname | grep -o '[0-9]*$')"
echo "127.0.1.1 $(hostname)" | sudo tee -a /etc/hosts

# Create HAProxy configuration file
echo "Configuring HAProxy..."
sudo bash -c 'cat <<EOF > /etc/haproxy/haproxy.cfg
global
    log /dev/log local0
    log /dev/log local1 notice
    chroot /var/lib/haproxy
    stats socket /run/haproxy/admin.sock mode 660 level admin
    stats timeout 30s
    user haproxy
    group haproxy
    daemon

defaults
    log global
    mode http
    option httplog
    option dontlognull
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms
    errorfile 400 /etc/haproxy/errors/400.http
    errorfile 403 /etc/haproxy/errors/403.http
    errorfile 408 /etc/haproxy/errors/408.http
    errorfile 500 /etc/haproxy/errors/500.http
    errorfile 502 /etc/haproxy/errors/502.http
    errorfile 503 /etc/haproxy/errors/503.http
    errorfile 504 /etc/haproxy/errors/504.http

frontend http_front
    bind *:80
    stats uri /haproxy?stats
    default_backend http_back

backend http_back
    balance roundrobin
    server 414383-web-01 34.202.158.29:80 check
    server 414383-web-02 18.235.234.223:80 check
EOF'

# Enable and start the HAProxy service
echo "Enabling and starting HAProxy..."
sudo service haproxy enable
sudo service haproxy restart

# Verify HAProxy is running
if service haproxy status | grep -q "active (running)"; then
    echo "HAProxy is running successfully."
else
    echo "HAProxy failed to start. Check logs for details." >&2
    exit 1
fi

echo "HAProxy installation and configuration completed successfully."
